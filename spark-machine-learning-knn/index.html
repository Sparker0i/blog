<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Spark ML: K Nearest Neighbours</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preload" href="/assets/css/app.css?v=4055984ae1" as="style" />
    <link rel="preload" href="/assets/js/manifest.js?v=4055984ae1" as="script" />
    <link rel="preload" href="/assets/js/vendor/content-api.min.js?v=4055984ae1" as="script" />
    <link rel="preload" href="/assets/js/vendor.js?v=4055984ae1" as="script" />
    <link rel="preload" href="/assets/js/app.js?v=4055984ae1" as="script" />

      <link rel="preload" href="/assets/css/post.css?v=4055984ae1" as="style" />
  <link rel="preload" href="/assets/js/post.js?v=4055984ae1" as="script" />


    <style>
      /* These font-faces are here to make fonts work if the Ghost instance is installed in a subdirectory */

      /* source-sans-pro-regular */
      @font-face {
        font-family: 'Source Sans Pro';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: local('SourceSansPro-Regular'),
            url("/assets/fonts/source-sans-pro/latin/source-sans-pro-regular.woff2?v=4055984ae1") format('woff2'),
            url("/assets/fonts/source-sans-pro/latin/source-sans-pro-regular.woff?v=4055984ae1") format('woff');
      }

      /* source-sans-pro-600 */
      @font-face {
        font-family: 'Source Sans Pro';
        font-style: normal;
        font-weight: 600;
        font-display: swap;
        src: local('SourceSansPro-SemiBold'),
            url("/assets/fonts/source-sans-pro/latin/source-sans-pro-600.woff2?v=4055984ae1") format('woff2'),
            url("/assets/fonts/source-sans-pro/latin/source-sans-pro-600.woff?v=4055984ae1") format('woff');
      }

      /* source-sans-pro-700 */
      @font-face {
        font-family: 'Source Sans Pro';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: local('SourceSansPro-Bold'),
            url("/assets/fonts/source-sans-pro/latin/source-sans-pro-700.woff2?v=4055984ae1") format('woff2'),
            url("/assets/fonts/source-sans-pro/latin/source-sans-pro-700.woff?v=4055984ae1") format('woff');
      }

      /* iconmoon */
      @font-face {
        font-family: 'icomoon';
        font-weight: normal;
        font-style: normal;
        font-display: swap;
        src: url("/assets/fonts/icomoon/icomoon.eot?101fc3?v=4055984ae1");
        src: url("/assets/fonts/icomoon/icomoon.eot?101fc3#iefix?v=4055984ae1") format('embedded-opentype'),
        url("/assets/fonts/icomoon/icomoon.ttf?101fc3?v=4055984ae1") format('truetype'),
        url("/assets/fonts/icomoon/icomoon.woff?101fc3?v=4055984ae1") format('woff'),
        url("/assets/fonts/icomoon/icomoon.svg?101fc3#icomoon?v=4055984ae1") format('svg');
      }
    </style>

    <link rel="stylesheet" type="text/css" href="/assets/css/app.css?v=4055984ae1" media="screen" />

      <link rel="stylesheet" type="text/css" href="/assets/css/post.css?v=4055984ae1" media="screen" />


    

    <meta name="description" content="Learn how you can write a KNN algorithm from scratch and modify it for use with larger datasets in Spark" />
    <link rel="icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="http://localhost:2368/spark-machine-learning-knn/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="http://localhost:2368/spark-machine-learning-knn/amp/" />
    
    <meta property="og:site_name" content="Sparker0i&#x27;s Blog" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Spark ML: K Nearest Neighbours" />
    <meta property="og:description" content="Learn how you can write a KNN algorithm from scratch and modify it for use with larger datasets in Spark" />
    <meta property="og:url" content="http://localhost:2368/spark-machine-learning-knn/" />
    <meta property="og:image" content="http://localhost:2368/content/images/2020/04/mllib-1.jpg" />
    <meta property="article:published_time" content="2020-04-19T05:41:03.000Z" />
    <meta property="article:modified_time" content="2020-05-08T17:18:44.000Z" />
    <meta property="article:tag" content="Spark" />
    <meta property="article:tag" content="Spark ML" />
    <meta property="article:tag" content="Scala" />
    <meta property="article:tag" content="Big Data" />
    <meta property="article:tag" content="Machine Learning" />
    
    <meta property="article:publisher" content="https://www.facebook.com/Sparker0i" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Spark ML: K Nearest Neighbours" />
    <meta name="twitter:description" content="Learn how you can write a KNN algorithm from scratch and modify it for use with larger datasets in Spark" />
    <meta name="twitter:url" content="http://localhost:2368/spark-machine-learning-knn/" />
    <meta name="twitter:image" content="http://localhost:2368/content/images/2020/04/mllib-1.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Aaditya Menon" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Spark, Spark ML, Scala, Big Data, Machine Learning" />
    <meta name="twitter:site" content="@Sparker0i" />
    <meta name="twitter:creator" content="@Sparker0i" />
    <meta property="og:image:width" content="600" />
    <meta property="og:image:height" content="315" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Sparker0i&#x27;s Blog",
        "url": "http://localhost:2368/",
        "logo": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/content/images/2020/02/6006221719b070975f272141125c0689.png"
        }
    },
    "author": {
        "@type": "Person",
        "name": "Aaditya Menon",
        "image": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/content/images/2022/02/72678158_2843214719045409_4986419922138562560_n.jpg",
            "width": 2000,
            "height": 2000
        },
        "url": "http://localhost:2368/author/sparker0i/",
        "sameAs": [
            "https://twitter.com/Sparker0i"
        ]
    },
    "headline": "Spark ML: K Nearest Neighbours",
    "url": "http://localhost:2368/spark-machine-learning-knn/",
    "datePublished": "2020-04-19T05:41:03.000Z",
    "dateModified": "2020-05-08T17:18:44.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "http://localhost:2368/content/images/2020/04/mllib-1.jpg",
        "width": 600,
        "height": 315
    },
    "keywords": "Spark, Spark ML, Scala, Big Data, Machine Learning",
    "description": "Learn how you can write a KNN algorithm from scratch and modify it for use with larger datasets in Spark",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368/"
    }
}
    </script>

    <meta name="generator" content="Ghost 4.33" />
    <link rel="alternate" type="application/rss+xml" title="Sparker0i&#x27;s Blog" href="http://localhost:2368/rss/" />
    
    <script defer src="/public/cards.min.js?v=4055984ae1"></script>
    <link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=4055984ae1">
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7XJJR5L4E3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7XJJR5L4E3');
</script>
<meta property="fb:pages" content="110085507196751" />
<meta name="google-site-verification" content="dW-FKUoBj2jzKbsORQiymBPtiZ3ROGD5gseblJwYl80" />
<script data-ad-client="ca-pub-7053772126133454" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><style>:root {--ghost-accent-color: #00e1ff;}</style>

    <style>
      :root {
        --primary-subtle-color: var(--ghost-accent-color) !important;
      }
    </style>

    <script>
      // @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&dn=expat.txt Expat
      const ghostHost = "http://localhost:2368"
      // @license-end
    </script>

  </head>
  <body class="post-template tag-spark tag-spark-ml tag-scala tag-big-data tag-machine-learning">
    



  
<header class="m-header with-picture js-header">
  <div class="m-mobile-topbar" data-aos="fade-down">
    <button class="m-icon-button in-mobile-topbar js-open-menu" aria-label="Open menu">
      <span class="icon-menu" aria-hidden="true"></span>
    </button>
      <a href="http://localhost:2368" class="m-logo in-mobile-topbar">
        <img src="http://localhost:2368/content/images/2020/02/6006221719b070975f272141125c0689.png" alt="Sparker0i&#x27;s Blog" class="">
      </a>
    <button class="m-icon-button in-mobile-topbar js-open-search" aria-label="Open search">
      <span class="icon-search" aria-hidden="true"></span>
    </button>
  </div>

  <div class="m-menu js-menu">
    <button class="m-icon-button outlined as-close-menu js-close-menu" aria-label="Close menu">
      <span class="icon-close"></span>
    </button>
    <div class="m-menu__main" data-aos="fade-down">
      <div class="l-wrapper">
        <div class="m-nav js-main-nav">
          <nav class="m-nav__left js-main-nav-left" role="navigation" aria-label="Main menu">
            <ul>
                <li class="only-desktop">
                  <a href="http://localhost:2368" class="m-logo">
                    <img src="http://localhost:2368/content/images/2020/02/6006221719b070975f272141125c0689.png" alt="Sparker0i&#x27;s Blog" class="">
                  </a>
                </li>
                
    <li class="nav-scala">
      <a href="http://localhost:2368/tag/scala/">Scala</a>
    </li>
    <li class="nav-spark">
      <a href="http://localhost:2368/tag/spark/">Spark</a>
    </li>

              <li class="submenu-option js-submenu-option">
                <button class="m-icon-button in-menu-main more js-toggle-submenu" aria-label="Open submenu">
                  <span class="icon-more" aria-hidden="true"></span>
                </button>
                <div class="m-submenu js-submenu">
                  <div class="l-wrapper in-submenu">
                    <section class="m-recent-articles">
                      <h3 class="m-submenu-title in-recent-articles">Recent articles</h3>
                          <div class="swiper js-recent-slider">
                            <div class="swiper-wrapper">
                                <div class="swiper-slide">
                                  <a href="/podman-best-docker-alternative/" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="/content/images/size/w300/2022/03/podman-vs-docker.jpg" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="Podman with Desktop Companion: The best alternative to Docker Desktop">
                                      Podman with Desktop Companion: The best alternative to Docker Desktop
                                    </h3>
                                    <span class="m-recent-article__date">a few seconds ago</span>
                                  </a>
                                </div>
                                <div class="swiper-slide">
                                  <a href="/factors-to-look-dealing-crypto/" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="https://images.unsplash.com/photo-1621504450181-5d356f61d307?crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;fit&#x3D;max&amp;fm&#x3D;jpg&amp;ixid&#x3D;MnwxMTc3M3wwfDF8c2VhcmNofDN8fGNyeXB0b3xlbnwwfHx8fDE2MjgxMDYyOTU&amp;ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;w&#x3D;2000" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="Factors to look at while dealing with Cryptocurrencies">
                                      Factors to look at while dealing with Cryptocurrencies
                                    </h3>
                                    <span class="m-recent-article__date">8 months ago</span>
                                  </a>
                                </div>
                                <div class="swiper-slide">
                                  <a href="/health-targeted-digital-advertising-today/" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="/content/images/size/w300/2021/01/targeted-nontargeted-houston-marketing-display-advertising1.jpg" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="Is the state of targeted digital advertising broken?">
                                      Is the state of targeted digital advertising broken?
                                    </h3>
                                    <span class="m-recent-article__date">a year ago</span>
                                  </a>
                                </div>
                                <div class="swiper-slide">
                                  <a href="/run-spark-3-applications-on-gpu/" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="/content/images/size/w300/2020/09/untitled-3-.png" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="How to run Spark 3.0 applications on your GPU">
                                      How to run Spark 3.0 applications on your GPU
                                    </h3>
                                    <span class="m-recent-article__date">2 years ago</span>
                                  </a>
                                </div>
                            </div>
                          </div>
                    </section>
                    <section class="m-tags">
                      <h3 class="m-submenu-title">Tags</h3>
                        <ul>
                            <li>
                              <a href="/tag/2fa/">2FA</a>
                            </li>
                            <li>
                              <a href="/tag/adb/">ADB</a>
                            </li>
                            <li>
                              <a href="/tag/asus/">ASUS</a>
                            </li>
                            <li>
                              <a href="/tag/ads/">Ads</a>
                            </li>
                            <li>
                              <a href="/tag/advertising/">Advertising</a>
                            </li>
                            <li>
                              <a href="/tag/analysis/">Analysis</a>
                            </li>
                            <li>
                              <a href="/tag/android/">Android</a>
                            </li>
                            <li>
                              <a href="/tag/android-one/">Android One</a>
                            </li>
                            <li>
                              <a href="/tag/android-project/">Android Project</a>
                            </li>
                            <li>
                              <a href="/tag/assignment/">Assignment</a>
                            </li>
                        </ul>
                    </section>
                  </div>
                </div>
              </li>
            </ul>
          </nav>
          <div class="m-nav__right">
            <button class="m-icon-button in-menu-main js-open-search" aria-label="Open search">
              <span class="icon-search" aria-hidden="true"></span>
            </button>
            <div class="m-toggle-darkmode js-tooltip" data-tippy-content="Toggle light/dark mode" tabindex="0">
              <label for="toggle-darkmode" class="sr-only">
                Toggle light/dark mode
              </label>
              <input id="toggle-darkmode" type="checkbox" class="js-toggle-darkmode">
              <div>
                <span class="icon-moon moon" aria-hidden="true"></span>
                <span class="icon-sunny sun" aria-hidden="true"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</header>

<main class="main-wrap">
    
  <section class="m-hero with-picture" data-aos="fade">
    <div class="m-hero__picture in-post">
      <img
        srcset="
          /content/images/size/w300/2020/04/mllib-1.jpg 300w,
          /content/images/size/w600/2020/04/mllib-1.jpg 600w,
          /content/images/size/w1000/2020/04/mllib-1.jpg 1000w,
          /content/images/size/w2000/2020/04/mllib-1.jpg 2000w
        "
        sizes="(max-width: 600px) 600px, (max-width: 1000px) 1000px, 2000px"
        src="/content/images/size/w1000/2020/04/mllib-1.jpg"
        alt=""
      />
    </div>
    </section>
  
  <article>
    <div class="l-content in-post">
        <div class="l-wrapper in-post  js-aos-wrapper" data-aos="fade-up"
          data-aos-delay="300">
          <div
            class="l-post-content js-progress-content">
            <header class="m-heading">
              <h1 class="m-heading__title in-post">Cool Spark ML: K Nearest Neighbors</h1>
              <div class="m-heading__meta">
                  <a href="http://localhost:2368/tag/spark/" class="m-heading__meta__tag">Spark</a>
                  <span class="m-heading__meta__divider" aria-hidden="true">&bull;</span>
                <span class="m-heading__meta__time">Apr 19, 2020</span>
              </div>
            </header>
            <div class="pos-relative js-post-content">
              <div class="m-share">
                <div class="m-share__content js-sticky">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/spark-machine-learning-knn/"
                    class="m-icon-button filled in-share" target="_blank" rel="noopener" aria-label="Facebook">
                    <span class="icon-facebook" aria-hidden="true"></span>
                  </a>
                  <a href="https://twitter.com/intent/tweet?text=Cool%20Spark%20ML%3A%20K%20Nearest%20Neighbors&url=http://localhost:2368/spark-machine-learning-knn/"
                    class="m-icon-button filled in-share" target="_blank" rel="noopener" aria-label="Twitter">
                    <span class="icon-twitter" aria-hidden="true"></span>
                  </a>
                  <button class="m-icon-button filled in-share progress js-scrolltop" aria-label="Scroll to top">
                    <span class="icon-arrow-top" aria-hidden="true"></span>
                    <svg aria-hidden="true">
                      <circle class="progress-ring__circle js-progress" fill="transparent" r="0" />
                    </svg>
                  </button>
                </div>
              </div>
              <p><em>Note: This article is the first of the Series: Cool Spark ML. Other parts are coming soon.</em></p><p>I had taken up a few machine learning courses in my college throughout 2018. Most of the problems there were solved using Python and the necessary libraries - NumPy, Pandas, Scikit-Learn and Matplotlib. With my daily work at IBM now requiring me to use Scala and Spark, I decided to use my free time during the lockdown to try out Spark ML.</p><p><em>Note: All the codes in the Cool Spark ML Series will be available on <a href="https://github.com/Sparker0i/Cool-Spark-ML">my GitHub repo</a></em></p><h3 id="intro-to-spark-ml">Intro to Spark ML</h3><p>As the name suggests, Spark ML is the Machine Learning library consisting of common Machine learning algorithms - classification, regression, clustering etc.</p><h3 id="why-spark-ml">Why Spark ML?</h3><p>Pandas - a Python library - won’t work every time. It is a single machine tool, so it's constrained by the machine's limits. Moreover, pandas doesn’t have any parallelism built in, which means it uses only one CPU core. You may hit a dead-end on datasets of the size of a few gigabytes. Pandas won't help if you want to work on very big datasets.</p><p>We are now in the Big Data era, where gigabytes of data are generated every few seconds. Such datasets will require powerful systems to run even the basic machine learning algorithms. The cost of getting such a powerful system will be huge, as well as the costs to scale them up. With distributed computers, such calculations can be sent to multiple low-end machines, which prevents the cost of getting a single high-end machine.</p><p>This is where Spark kicks in. Spark has the concept of <code>DataFrame</code> (now deprecated in favor of Datasets), which behaves very similar to how a Pandas <code>DataFrame</code> would do, including having very similar APIs too. The advantage of using Spark <code>DataFrame</code> is that it was designed from ground-up to support Big Data. Spark can also distribute such <code>DataFrame</code>s across multiple machines and collect the calculated results.</p><h3 id="knn-k-nearest-neighbors">KNN: K-Nearest Neighbors</h3><p>The process in KNN is pretty simple. You load your entire dataset first, each of which will have input columns and one output column. This is then split into a training set and a testing set. You then use your training set to train your model, and then use the testing set to predict the output column value by testing it against the model. You then compare the actual and the predicted target values and calculate the accuracy of your model.</p><h3 id="problem-definition">Problem Definition</h3><p>We are going to train a model to predict the famous <a href="http://archive.ics.uci.edu/ml/datasets/iris">Iris dataset</a>. The Iris Flower Dataset involves predicting the flower species given measurements of iris flowers.</p><p>It is a multiclass classification problem. The number of observations for each class is the same. The dataset is small in size with only 150 rows with 4 input variables and 1 output variable.</p><p>The 4 features are described as follows:</p><ol><li>Sepal-Length, in cm</li><li>Sepal-Width, in cm</li><li>Petal-Length, in cm</li><li>Petal-Width, in cm</li></ol><h3 id="prerequisites">Prerequisites</h3><ol><li>Create a Scala project in IntelliJ IDEA based on SBT</li><li>Select Scala version 2.11.12</li><li>Include <code>spark-core</code>, <code>spark-sql</code> and <code>spark-ml</code> 2.4.5 as library dependencies in your <code>build.sbt</code></li></ol><h3 id="knn-steps">KNN Steps</h3><p>In this blog post, I will be developing KNN algorithm from scratch. The process to perform KNN can be broken down into 3 easy steps:</p><ol><li>Calculate Euclidean Distance</li><li>Get Nearest Neighbors</li><li>Make Predictions</li></ol><h3 id="step-1-calculate-euclidean-distance">Step 1: Calculate Euclidean Distance</h3><p>The first step will be to calculate the distance between two rows in a Dataset. Rows of data are mostly made up of numbers and an easy way to calculate the distance between two rows or vectors of numbers is to draw a straight line.</p><p>Euclidean Distance is calculated as the square root of the sum of the squared differences between the two vectors, as given in the image below:</p><!--kg-card-begin: html--><a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\bg_white&space;{\color{Red}&space;$$dist_{x_1,x_2}&space;=&space;\sqrt{\sum_{i=0}^{N}&space;({x_1_i&space;-&space;x_2_i})^2}.$$}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\inline&space;\bg_white&space;{\color{Red}&space;$$dist_{x_1,x_2}&space;=&space;\sqrt{\sum_{i=0}^{N}&space;({x_1_i&space;-&space;x_2_i})^2}.$$}" title="{\color{Red} $$dist_{p_1,p_2} = \sqrt{\sum_{i=0}^{N} ({x_1_i - x_2_i})^2}.$$}" /></a><!--kg-card-end: html--><p>Where <code>x1</code> is the first row of data, <code>x2</code> is the second row of data, and <code>i</code> is a specific index for a column as we sum across all columns. Smaller the value, more similar will be the two rows.</p><p>Since we will be reading our data and transforming it using Spark, to compute distances between two <code>Row</code>s in a <code>DataFrame</code>, we write the function below in Scala:</p><figure class="kg-card kg-code-card"><pre><code class="language-scala">def computeEuclideanDistance(row1: Row, row2: Row): Double = {
    var distance = 0.0
    for (i &lt;- 0 until row1.length - 1) {
        distance += math.pow(row1.getDouble(i) - row2.getDouble(i), 2)
    }
    math.sqrt(distance)
}</code></pre><figcaption>Code to compute Euclidean Distance</figcaption></figure><p>You can see that the function assumes that the last column in each row is an output value which is ignored from the distance calculation.</p><h3 id="step-2-get-nearest-neighbors">Step 2: Get Nearest Neighbors</h3><p>Neighbors for a new piece of data in the dataset are the k closest instances, as defined by our distance measure. To locate the neighbors for a new piece of data within a dataset we must first calculate the distance between each record in the dataset to the new piece of data. We can do this using our distance function prepared above.</p><p>We can do this by keeping track of the distance for each record in the dataset as a tuple, sort the list of tuples by the distance, and then retrieve the neighbors. The below function does this job in Scala:</p><figure class="kg-card kg-code-card"><pre><code class="language-scala">def getNeighbours(trainSet: Array[Row], testRow: Row, k: Int): List[Row] = {
    var distances = mutable.MutableList[(Row, Double)]()
    trainSet.foreach{trainRow =&gt;
        val dist = computeEuclideanDistance(trainRow, testRow)
        val x = (trainRow, dist)
        distances += x
    }
    distances = distances.sortBy(_._2)
    var neighbours = mutable.MutableList[Row]()

    for (i &lt;- 1 to k) {
        neighbours += distances(i)._1
    }
    neighbours.toList
}</code></pre><figcaption>Retrieve The k nearest neighbors for a new data element</figcaption></figure><h3 id="step-3-make-predictions">Step 3: Make Predictions</h3><p>The most similar neighbors collected from the training dataset can be used to make predictions. In the case of classification, we can return the most represented output value (Class) among the neighbors.</p><p>We would first map the class values to the number of times it appears among the neighbors, then sort the counts in descending order and get the most appeared class value. The below function does exactly that in Scala:</p><figure class="kg-card kg-code-card"><pre><code class="language-scala">def predictClassification(trainSet: Array[Row], testRow: Row, k: Int): String =
{
    val neighbours = getNeighbours(trainSet, testRow, k)
    val outputValues = for (row &lt;- neighbours) yield row.getString(trainSet(0).length - 1)
    outputValues.groupBy(identity)
        .mapValues(_.size)
        .toSeq
        .sortWith(_._2 &gt; _._2)
        .head._1
}</code></pre><figcaption>Make prediction on the class value of a new data element</figcaption></figure><h3 id="apply-the-above-concepts-to-iris-dataset">Apply the above concepts to Iris Dataset</h3><p>We will now apply the concepts above to perform KNN on the Iris Dataset.</p><p>First, we have to load the dataset into the program. This is done using the <code>readCsv</code> function I've written below:</p><figure class="kg-card kg-code-card"><pre><code class="language-scala">def readCsv(fileName: String, header: Boolean): DataFrame = {
    spark.read
        .format("csv")
        .option("header", header)
        .option("inferSchema", header)
        .load(fileName)
        .repartition($"Class")
}</code></pre><figcaption>Code to read a CSV into a DataFrame</figcaption></figure><p>We also have to normalize the data we have. This is because KNN is based on distance between records. Unless data is normalized distance will be incorrectly calculated, because different attributes will not contribute to the distance in a uniform way.  Attributes having a larger value range will have an unduly large influence on the distance, because they make greater contribution to the distance. If the dataset requires that some columns be given a greater preference over others, then normalization isn't recommended, but this is not true in the case of the Iris dataset.</p><p>We use the Z Score Normalization technique. With this, we subtract the mean of the respective column from each cell, and divide that with the standard deviation of that column. <a href="https://towardsdatascience.com/understand-data-normalization-in-machine-learning-8ff3062101f0">This</a> article describes Data Normalization in good detail.</p><p>The following function does our job:</p><pre><code class="language-scala">def normalizeData(): Unit = {
    df.columns.filterNot(e =&gt; e == "Class").foreach{col =&gt;
        val (mean_col, stddev_col) = df.select(mean(col), stddev(col))
            .as[(Double, Double)]
            .first()
        df = df.withColumn(s"$col.norm", ($"$col" - mean_col) / stddev_col)
            .drop(col)
            .withColumnRenamed(s"$col.norm", col)
    }
}</code></pre><p>As you can see above, we are filtering out the class value, because we will not be using this value to compute the distance. There's one problem with our approach though, our KNN functions written above assume that the class value will be the last column. In the way we've normalized the data, we are dropping the original column, and adding the normalized column in place. This will push the <code>Class</code> column to the beginning. So, I've written another function which will move the column back to where it should actually be:</p><pre><code class="language-scala">def moveClassToEnd(): Unit = {
    val cols = df.columns.filterNot(_ == "Class") ++ Array("Class")
    df = df.select(cols.head, cols.tail: _*)
}</code></pre><p>We will evaluate our algorithm using K-fold cross-validation with 5 folds. This means that we will have 150/5 = 30 rows per fold. We will use helper functions <code>evaluateAlgorithm()</code> and <code>accuracyMetric()</code> to evaluate the algorithm for cross-validation and calculate the accuracy of our predictions respectively.</p><p>Since Spark does not allow any of its operations inside a Spark transformation, we will have to perform a <code>collect()</code> on the Train set and Test set <code>DataFrame</code>s every time before passing it to any function. A sample run with <code>k = 3</code> produces the following output:</p><figure class="kg-card kg-image-card"><img src="http://localhost:2368/content/images/2020/04/KNN-Accuracy.png" class="kg-image" alt loading="lazy"></figure><p>Let's go one step further and run our program over different values of <code>k</code>. I'm running it for <code>k</code> from <code>1 to 10</code>, and here are some results (this may not be the same everytime): </p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="http://localhost:2368/content/images/2020/04/image.png" class="kg-image" alt loading="lazy"><figcaption>KNN accuracy for a variety of k values</figcaption></figure><p>You can find the entire code below:</p><!--kg-card-begin: html--><script src="https://gist-it.appspot.com/github/Sparker0i/Cool-Spark-ML/blob/master/src/main/scala/me/sparker0i/machinelearning/classification/KNN.scala"></script><!--kg-card-end: html--><h3 id="conclusion">CONCLUSION</h3><p>While Spark ideally shouldn't be used smaller datasets like this, you could apply the same thought process and transform this code to use for some larger datasets, and there you will see the magic of Spark over Pandas.</p><p>Inspired heavily from <a href="https://machinelearningmastery.com/tutorial-to-implement-k-nearest-neighbors-in-python-from-scratch/">this</a> great article.</p>
                <section class="m-tags in-post">
                  <h3 class="m-submenu-title">Tags</h3>
                  <ul>
                      <li>
                        <a href="/tag/spark/" title="Spark">Spark</a>
                      </li>
                      <li>
                        <a href="/tag/spark-ml/" title="Spark ML">Spark ML</a>
                      </li>
                      <li>
                        <a href="/tag/scala/" title="Scala">Scala</a>
                      </li>
                      <li>
                        <a href="/tag/big-data/" title="Big Data">Big Data</a>
                      </li>
                      <li>
                        <a href="/tag/machine-learning/" title="Machine Learning">Machine Learning</a>
                      </li>
                  </ul>
                </section>
            </div>
          </div>
        </div>
        <section class="m-author">
          <div class="m-author__content">
            <div class="m-author__picture">
              <a href="http://localhost:2368/author/sparker0i/" class="m-author-picture" aria-label="Aaditya Menon">
                  <div style="background-image: url(http://localhost:2368/content/images/2022/02/72678158_2843214719045409_4986419922138562560_n.jpg);"></div>
              </a>
            </div>
            <div class="m-author__info">
              <h4 class="m-author__name">
                <a href="http://localhost:2368/author/sparker0i/">Aaditya Menon</a>
              </h4>
              <ul class="m-author-links">
                  <li>
                    <a href="https://twitter.com/@Sparker0i" target="_blank" rel="noopener" aria-label="Twitter">
                      <span class="icon-twitter" aria-hidden="true"></span>
                    </a>
                  </li>
              </ul>
            </div>
          </div>
        </section>
            <section class="m-recommended">
              <div class="l-wrapper in-recommended">
                <h3 class="m-section-title in-recommended">Recommended for you</h3>
                <div class="m-recommended-articles">
                  <div class="m-recommended-slider swiper js-recommended-slider">
                    <div class="swiper-wrapper">
                      
    <div class="m-recommended-slider__item swiper-slide">
  <article class="m-article-card  post tag-spark tag-scala tag-graphics tag-nvidia tag-gpu featured">
    <div class="m-article-card__picture">
      <a href="/run-spark-3-applications-on-gpu/" class="m-article-card__picture-link" aria-hidden="true" tabindex="-1"></a>
        <img class="m-article-card__picture-background" src="/content/images/size/w600/2020/09/untitled-3-.png" loading="lazy" alt="">
      <a href="http://localhost:2368/author/sparker0i/" class="m-article-card__author js-tooltip" aria-label="Aaditya Menon" data-tippy-content="Posted by Aaditya Menon ">
          <div style="background-image: url(/content/images/size/w100/2022/02/72678158_2843214719045409_4986419922138562560_n.jpg);"></div>
      </a>
        <a href="/run-spark-3-applications-on-gpu/" class="m-article-card__featured js-tooltip" data-tippy-content="Featured" aria-label="Featured">
          <span class="icon-star" aria-hidden="true"></span>
        </a>
    </div>
      <div class="m-article-card__info">
        <a href="http://localhost:2368/tag/spark/" class="m-article-card__tag">Spark</a>
      <a href="/run-spark-3-applications-on-gpu/" class="m-article-card__info-link" aria-label="How to run Spark 3.0 applications on your GPU">
        <div>
          <h2 class="m-article-card__title js-article-card-title " title="How to run Spark 3.0 applications on your GPU">
            How to run Spark 3.0 applications on your GPU
          </h2>
        </div>
        <div class="m-article-card__timestamp">
          <span>2 years ago</span>
          <span>&bull;</span>
          <span>4 min read</span>
        </div>
      </a>
    </div>
  </article>
    </div>
    <div class="m-recommended-slider__item swiper-slide">
  <article class="m-article-card  post tag-spark tag-spark-ml tag-nvidia">
    <div class="m-article-card__picture">
      <a href="/spark-3-native-gpu-integration/" class="m-article-card__picture-link" aria-hidden="true" tabindex="-1"></a>
        <img class="m-article-card__picture-background" src="/content/images/size/w600/2020/05/NVIDIA-Accelerates-Apache-Spark.jpg" loading="lazy" alt="">
      <a href="http://localhost:2368/author/sparker0i/" class="m-article-card__author js-tooltip" aria-label="Aaditya Menon" data-tippy-content="Posted by Aaditya Menon ">
          <div style="background-image: url(/content/images/size/w100/2022/02/72678158_2843214719045409_4986419922138562560_n.jpg);"></div>
      </a>
    </div>
      <div class="m-article-card__info">
        <a href="http://localhost:2368/tag/spark/" class="m-article-card__tag">Spark</a>
      <a href="/spark-3-native-gpu-integration/" class="m-article-card__info-link" aria-label="Spark 3.0 adds native GPU integration: Why that matters?">
        <div>
          <h2 class="m-article-card__title js-article-card-title " title="Spark 3.0 adds native GPU integration: Why that matters?">
            Spark 3.0 adds native GPU integration: Why that matters?
          </h2>
        </div>
        <div class="m-article-card__timestamp">
          <span>2 years ago</span>
          <span>&bull;</span>
          <span>3 min read</span>
        </div>
      </a>
    </div>
  </article>
    </div>
    <div class="m-recommended-slider__item swiper-slide">
  <article class="m-article-card  post tag-spark tag-spark-ml">
    <div class="m-article-card__picture">
      <a href="/spark-ml-data-preprocessing/" class="m-article-card__picture-link" aria-hidden="true" tabindex="-1"></a>
        <img class="m-article-card__picture-background" src="/content/images/size/w600/2020/05/mllib.jpg" loading="lazy" alt="">
      <a href="http://localhost:2368/author/sparker0i/" class="m-article-card__author js-tooltip" aria-label="Aaditya Menon" data-tippy-content="Posted by Aaditya Menon ">
          <div style="background-image: url(/content/images/size/w100/2022/02/72678158_2843214719045409_4986419922138562560_n.jpg);"></div>
      </a>
    </div>
      <div class="m-article-card__info">
        <a href="http://localhost:2368/tag/spark/" class="m-article-card__tag">Spark</a>
      <a href="/spark-ml-data-preprocessing/" class="m-article-card__info-link" aria-label="Cool Spark ML - Part 2: Preprocessing of Data">
        <div>
          <h2 class="m-article-card__title js-article-card-title " title="Cool Spark ML - Part 2: Preprocessing of Data">
            Cool Spark ML - Part 2: Preprocessing of Data
          </h2>
        </div>
        <div class="m-article-card__timestamp">
          <span>2 years ago</span>
          <span>&bull;</span>
          <span>10 min read</span>
        </div>
      </a>
    </div>
  </article>
    </div>
                    </div>
                    <button class="m-icon-button filled in-recommended-articles swiper-button-prev" aria-label="Previous">
                      <span class="icon-arrow-left" aria-hidden="true"></span>
                    </button>
                    <button class="m-icon-button filled in-recommended-articles swiper-button-next" aria-label="Next">
                      <span class="icon-arrow-right" aria-hidden="true"></span>
                    </button>
                  </div>
                </div>
              </div>
            </section>
    </div>
  </article>
</main>



    
<div class="m-search js-search" role="dialog" aria-modal="true" aria-label="Search">
  <button class="m-icon-button outlined as-close-search js-close-search" aria-label="Close search">
    <span class="icon-close" aria-hidden="true"></span>
  </button>
  <div class="m-search__content">
    <form class="m-search__form">
      <div class="pos-relative">
        <span class="icon-search m-search-icon" aria-hidden="true"></span>
        <label for="search-input" class="sr-only">
          Type to search
        </label>
        <input id="search-input" type="text" class="m-input in-search js-input-search" placeholder="Type to search">
      </div>
    </form>
    <div class="js-search-results hide"></div>
    <p class="m-not-found align-center hide js-no-results">
      No results for your search, please try with something else.
    </p>
  </div>
</div>

    
<footer class="m-footer">
  <div class="m-footer__content">
    <nav class="m-footer-social">
        <a href="https://www.facebook.com/Sparker0i" target="_blank" rel="noopener" aria-label="Facebook">
          <span class="icon-facebook" aria-hidden="true"></span>
        </a>
        <a href="https://twitter.com/Sparker0i" target="_blank" rel="noopener" aria-label="Twitter">
          <span class="icon-twitter" aria-hidden="true"></span>
        </a>
      <a href="http://localhost:2368/rss" aria-label="RSS">
        <span class="icon-rss" aria-hidden="true"></span>
      </a>
    </nav>
    <p class="m-footer-copyright">
      <span>Sparker0i&#x27;s Blog &copy; 2022</span>
      <span>&nbsp; &bull; &nbsp;</span>
      <span>Published with <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a></span>
    </p>
    <p class="m-footer-copyright jslicense">
      <a href="/assets/html/javascript.html?v=4055984ae1" rel="jslicense">JavaScript license information</a>
    </p>
  </div>
</footer>

    <script defer src="/assets/js/manifest.js?v=4055984ae1"></script>
    <script defer src="/assets/js/vendor/content-api.min.js?v=4055984ae1"></script>
    <script defer src="/assets/js/vendor.js?v=4055984ae1"></script>
    <script defer src="/assets/js/app.js?v=4055984ae1"></script>

      <script defer src="/assets/js/post.js?v=4055984ae1"></script>


    <script>
  var followSocialMedia = {
    youtube: ["https://www.youtube.com/c/sparker0i", "Sparker0i"],
    instagram: ["https://instagram.com/sparker0i", "Sparker0i"],
    github: ["https://github.com/sparker0i", "Sparker0i"],
    linkedin: ["https://www.linkedin.com/in/sparker0i", "Sparker0i"]
  };
</script>

<script>
  var youTube = {
    name: "Sparker0i",
    channelId: "UC720N9wQAevIjCD50x4RliQ",
  };
</script>

<script>
  var disqusShortName = "sparker0is-blog";
</script>

<script>
	var searchSettings = {
        key: "12584d6e462ba2c007d10f133c",
        url: "https://blog.sparker0i.me",
        options: {
          keys: ["title"],
          limit: 10,
        },
        api: {
          resource: "posts",
          parameters: {
            limit: "all",
            fields: ["title", "slug"],
            filter: "",
            include: "",
            order: "",
            formats: "",
          },
        },
    };
</script>
  </body>
</html>
